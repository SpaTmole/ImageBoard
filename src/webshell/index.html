<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Welcome, comrade!</title>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
</head>
<body>
    <form method="get" id="main">
        <label for="main">
            Card ID:
            <input name="id" type="text">
        </label>
        <button id="submit_btn" type="submit" > Fetch </button>
    </form>
    <hr/>
    <button id="load_all"> Load all </button>
    <hr/>
    <form method="post" enctype="multipart/form-data" id="post_form">
        <label for="post_form">
            Upload your photo:
            <input type="file" id="file-input" name="photo">
        </label>
        <label for="post_form">
            Write some description to this photo:
            <input type="text" name="description">
        </label>
        <input name="attach_photo" type="submit" value="Send photo">
    </form>
    <div id="img_container">
    </div>

</body>
<script type="text/javascript">
    var url = "http://localhost:8080/rest/card/";
    $(document).ready(function(){
        $('form#post_form').attr('action', url);
        var handle_request = function(e){
            e.preventDefault();
            var data = $("input[name='id']").val(),
                request_uri = url + data;
            if(!data)
                return $('#load_all').trigger('click');
            $.getJSON(request_uri, null, function(data){
                if(data){
                    var img = $('<img src="data:image/png;base64,'+data.url+'"/>');
                    var description = $('<div class="content-descriprion"></div>');
                    description.text(data.description);
                    $('#img_container').append(img).append(description);
                }
            }).fail(function () {
                console.log("Request failed: ", arguments);
            });
        };
        $("#submit_btn").on('click', handle_request);
        $("input[name='id']").on('keydown', function(e){
            if(e.which == 13){
                handle_request.call(this, e);
            }
        });
        if(window.FormData) {
            $('input[name="attach_photo"]').on('click', function (e) {
                e.preventDefault();
                var data = new FormData();
                $.each($('#file-input')[0].files, function(i, file) {
                    data.append('photo', file);
                });
                data.append("description", $('input[name="description"]').val());
                $.ajax({
                    url: url,
                    type: "POST",
                    data: data,
                    cache: false,
                    contentType: false,
                    dataType: 'json',
                    processData: false,
                    success: function (data) {
                        console.log("success ", arguments)
                    },
                    error: function () {
                        console.log("fail ", arguments)
                    },
                    complete: function () {
                        console.log("complete");
                    }
                })
            })
        }
        $('#load_all').on('click', function(){
            var container = $('#img_container');
            container.fadeOut(400);
            $.getJSON(url, null, function(data){
                container.children().remove();
                var builder = function (src, desc) {
                        var mainfrm = $('<p></p>'),
                            img = $('<img/>'),
                            text = $('<p></p>');
                        if(src){
                            img.attr("src", 'data:image/png;base64,' + src);
                            mainfrm.append(img);
                        }
                        if(desc){
                            text.text(desc);
                            mainfrm.append(text);
                        }
                        return mainfrm;
                    };

                if(data){
                    for(var i in data){
                        var record = data[i];
                        container.append(builder(record.url, record.description));
                    }
                } else {
                    container.append($("<p>No available data.</p>"));
                }
                container.fadeIn(400);
            })
        })
    });
</script>
</html>